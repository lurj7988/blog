import{_ as p}from"./plugin-vue_export-helper-c27b6911.js";import{r as e,o as c,c as u,a as l,b as n,d as s,f as t,e as o}from"./app-0d33a0ff.js";const i={},k=n("h1",{id:"手撸java提取qsv文件视频内容",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#手撸java提取qsv文件视频内容","aria-hidden":"true"},"#"),s(" 手撸Java提取QSV文件视频内容")],-1),r=n("p",null,"QSV文件的构成详见上一篇文章，这篇文章带你手把手撸一遍代码。",-1),d=o(`<h2 id="创建类" tabindex="-1"><a class="header-anchor" href="#创建类" aria-hidden="true">#</a> 创建类</h2><p>第一步新建一个java类<code>QSV</code>，构造函数传入需要解析的文件名称。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QSV</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token class-name">RandomAccessFile</span> randomAccessFile<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">QSV</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">FileNotFoundException</span> <span class="token punctuation">{</span>
        randomAccessFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="通用方法" tabindex="-1"><a class="header-anchor" href="#通用方法" aria-hidden="true">#</a> 通用方法</h2><h3 id="逐字节读取文件" tabindex="-1"><a class="header-anchor" href="#逐字节读取文件" aria-hidden="true">#</a> 逐字节读取文件</h3><p>我们需要逐个字节读取文件，这边就需要jdk自带的类<code>RandomAccessFile</code>，先定义一个通用函数，输出偏移位置和字节大小获取字节数组。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* <span class="token keyword">@param</span> <span class="token parameter">offset</span> 偏移未知
* <span class="token keyword">@param</span> <span class="token parameter">size</span>   字节大小
* <span class="token keyword">@return</span> 字节数组
* <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
*/</span>
<span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//指针移动至偏移位置</span>
    randomAccessFile<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//需要读取的字节数</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    randomAccessFile<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="字节数组转16进制字符串" tabindex="-1"><a class="header-anchor" href="#字节数组转16进制字符串" aria-hidden="true">#</a> 字节数组转16进制字符串</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">HEX_VOCABLE</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token char">&#39;0&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;2&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;3&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;4&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;5&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;6&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;7&#39;</span><span class="token punctuation">,</span>
        <span class="token char">&#39;8&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;9&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;A&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;B&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;C&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;D&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;E&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;F&#39;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
* 字节数组转16进制字符串
*
* <span class="token keyword">@param</span> <span class="token parameter">bs</span>
* <span class="token keyword">@return</span>
*/</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">bytesToHex</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">byte</span> b <span class="token operator">:</span> bs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> high <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0f</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> low <span class="token operator">=</span> b <span class="token operator">&amp;</span> <span class="token number">0x0f</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">HEX_VOCABLE</span><span class="token punctuation">[</span>high<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">HEX_VOCABLE</span><span class="token punctuation">[</span>low<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="字节数组转int" tabindex="-1"><a class="header-anchor" href="#字节数组转int" aria-hidden="true">#</a> 字节数组转int</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 字节数组转int
*
* <span class="token keyword">@param</span> <span class="token parameter">b</span>
* <span class="token keyword">@return</span>
*/</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">toInt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res <span class="token operator">+=</span> <span class="token punctuation">(</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="老版本解密算法" tabindex="-1"><a class="header-anchor" href="#老版本解密算法" aria-hidden="true">#</a> 老版本解密算法</h2><p>老版本解密方法比较简单，先看下C的写法：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// 定义1个字节内存</span>
<span class="token keyword">typedef</span> <span class="token class-name">uint8_t</span> BYTE<span class="token punctuation">;</span>
<span class="token comment">// 定义4个字节内存</span>
<span class="token keyword">typedef</span> <span class="token class-name">uint32_t</span> DWORD<span class="token punctuation">;</span>
<span class="token comment">// decryption algorithm for some segments in qsv version 0x1</span>
<span class="token keyword">void</span> <span class="token function">decrypt_1</span><span class="token punctuation">(</span>BYTE<span class="token operator">*</span> buffer<span class="token punctuation">,</span> DWORD size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> BYTE dict<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">0x79</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        DWORD j <span class="token operator">=</span> <span class="token operator">~</span>i <span class="token operator">&amp;</span> <span class="token number">0x3</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^=</span> dict<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以直接用byte数组和long类型替换c的内存定义，这边没问题时因为没有位移算法，后面新版本解密算法会讲到。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">decrypt_1</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bs<span class="token punctuation">,</span> <span class="token keyword">long</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">0x79</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//先取反再与运算</span>
        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token operator">~</span>i <span class="token operator">&amp;</span> <span class="token number">0x3</span><span class="token punctuation">;</span>
        <span class="token comment">//异或运算</span>
        bs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^=</span> b<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="新版本解密算法" tabindex="-1"><a class="header-anchor" href="#新版本解密算法" aria-hidden="true">#</a> 新版本解密算法</h2><p>新版本解密算法比较复杂，同样先看下c的写法：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// 定义1个字节内存</span>
<span class="token keyword">typedef</span> <span class="token class-name">uint8_t</span> BYTE<span class="token punctuation">;</span>
<span class="token comment">// 定义4个字节内存</span>
<span class="token keyword">typedef</span> <span class="token class-name">uint32_t</span> DWORD<span class="token punctuation">;</span>
<span class="token comment">// decryption algorithm for some segments in qsv version 0x2</span>
<span class="token keyword">void</span> <span class="token function">decrypt_2</span><span class="token punctuation">(</span>BYTE<span class="token operator">*</span> buffer<span class="token punctuation">,</span> DWORD size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DWORD x <span class="token operator">=</span> <span class="token number">0x62677079</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;&gt;</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        x <span class="token operator">^=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x <span class="token operator">^=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        x <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;&lt;</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DWORD j <span class="token operator">=</span> x <span class="token operator">%</span> i<span class="token punctuation">;</span>
        BYTE tmp <span class="token operator">=</span> buffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> tmp <span class="token operator">^</span> <span class="token punctuation">(</span>BYTE<span class="token punctuation">)</span><span class="token operator">~</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这边注意c的写法有位移，定义的<code>DWORD</code>占32位内存，而java与之对应的<code>int</code>类型也是占32位内存，取值范围是<code>-2^31~2^31-1</code>(即<code>-2147483648~2147483647</code>)，如果超出这个范围java需要用long，而long占64位内存取反和位移都是按64位进行的与C的32位取反位移计算结果肯定有差异。</p><p>比如：2147483648，转换位二进制表示：10000000000000000000000000000000，C的写法由于<code>DWORD</code>占32位内存，左移一位后超出32为故就变成00000000000000000000000000000000，而java已经超出了int的取值范围，只能用long定义，由于long占64位，左移一位不会超出，结果也就不一样了。</p><p>又比如：9147483648，转为二进制表示：1000100001001110111000011000000000，已经超出32位，存到<code>DWORD</code>中的只保留右边的32位，即00100001001110111000011000000000，左移以为变成01000010011101110000110000000000，转为10进制为1115098112，而java采用long定义不会超出64位，左移结果位10001000010011101110000110000000000，转为十进制表示为18294967296，与C的结果相差较大。那么有办法解决吗，答案肯定是有的，我们需要重新写一个位移算法。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 左移
*
* <span class="token keyword">@param</span> <span class="token parameter">value</span> long
* <span class="token keyword">@param</span> <span class="token parameter">i</span>     位移量
* <span class="token keyword">@return</span> long
*/</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">longLeftShift</span><span class="token punctuation">(</span><span class="token keyword">long</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> binary <span class="token operator">=</span> <span class="token function">format32</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    binary <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%0&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>binary<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
* 右移
*
* <span class="token keyword">@param</span> <span class="token parameter">value</span> long
* <span class="token keyword">@param</span> <span class="token parameter">i</span>     位移量
* <span class="token keyword">@return</span> long
*/</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">longRightShift</span><span class="token punctuation">(</span><span class="token keyword">long</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> binary <span class="token operator">=</span> <span class="token function">format32</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    binary <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%0&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> binary<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>binary<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">format32</span><span class="token punctuation">(</span><span class="token keyword">long</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> binary <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toBinaryString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>binary<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//补满32位</span>
        binary <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%0&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">-</span> binary<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> binary<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//多余的截取掉</span>
        binary <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>binary<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> binary<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有了新定义的位移算法，解密算法就可以修改为：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">decrypt_2</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> x <span class="token operator">=</span> <span class="token number">0x62677079</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x <span class="token operator">=</span> <span class="token function">longLeftShift</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">longRightShift</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        x <span class="token operator">^=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x <span class="token operator">^=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        x <span class="token operator">=</span> <span class="token function">longRightShift</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">longLeftShift</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>x <span class="token operator">%</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span> tmp <span class="token operator">=</span> buffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>tmp <span class="token operator">^</span> <span class="token operator">~</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="获取qsv头部信息" tabindex="-1"><a class="header-anchor" href="#获取qsv头部信息" aria-hidden="true">#</a> 获取QSV头部信息</h2><p>上一篇文章讲到，头部信息共90个字节，<code>signature</code>(10byte)+<code>version</code>(4byte)+<code>vid</code>(16byte)+<code>_unknown1</code>(4byte)+<code>_unknown2</code>(32byte)+<code>_unknown3</code>(4byte)+<code>_unknown4</code>(4byte)+<code>json_offset</code>(8byte)+<code>json_size</code>(4byte)+<code>nb_indices</code>(4byte)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">QSV</span> qsv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QSV</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\\\workspace\\\\c\\\\风吹半夏第1集-蓝光1080P.qsv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qsv<span class="token punctuation">.</span><span class="token function">readHead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qsv<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readHead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//signature:10byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> signature <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0xA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//version:4byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> version <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0xA</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//vid:16byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> vid <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0xE</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//_unknown1:4byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _unknown1 <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x1E</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//_unknown2:32byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _unknown2 <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//_unknown3:4byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _unknown3 <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//_unknown4:4byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _unknown4 <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x46</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//json_offset:8byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> json_offset <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x4A</span><span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//json_size:4byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> json_size <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x52</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//nb_indices:4byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nb_indices <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;signature:%s\\nversion:%s\\nvid:%s\\n_unknown1:%s\\n_unknown2:%s\\n_unknown3:%s\\n_unknown4:%s\\njson_offset:0x%s\\njson_size:0x%s\\nnb_indices:0x%s&quot;</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">toInt</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">bytesToHex</span><span class="token punctuation">(</span>vid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">bytesToHex</span><span class="token punctuation">(</span>_unknown1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">bytesToHex</span><span class="token punctuation">(</span>_unknown2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">bytesToHex</span><span class="token punctuation">(</span>_unknown3<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">bytesToHex</span><span class="token punctuation">(</span>_unknown4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>json_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>json_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>nb_indices<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果：</p><div class="language-txt line-numbers-mode" data-ext="txt"><pre class="language-txt"><code>signature:QIYI VIDEO
version:2
vid:A90EA47D4333331BB85F331C1130504C
_unknown1:01000000
_unknown2:0000000000000000000000000000000000000000000000000000000000000000
_unknown3:01000000
_unknown4:01000000
json_offset:0x167
json_size:0x1d81
nb_indices:0x7
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="获取json数据" tabindex="-1"><a class="header-anchor" href="#获取json数据" aria-hidden="true">#</a> 获取json数据</h2><p>获取json数据需要先获取头部信息记录的json的偏移位置和字节大小，获取到的字节数组再通过老版本解密算法解密即可。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">QSV</span> qsv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QSV</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\\\workspace\\\\c\\\\风吹半夏第1集-蓝光1080P.qsv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qsv<span class="token punctuation">.</span><span class="token function">readJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qsv<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//json_offset:8byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> json_offset <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x4A</span><span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//json_size:4byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> json_size <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x52</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//json</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bs <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>json_offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">toInt</span><span class="token punctuation">(</span>json_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">decrypt_1</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> bs<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;json_offset:0x%s\\njson_size:0x%s&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>json_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>json_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果：</p><div class="language-txt line-numbers-mode" data-ext="txt"><pre class="language-txt"><code>json_offset:0x167
json_size:0x1d81
QYVI   {&quot;qsv_info&quot;:{&quot;ad&quot;:{},&quot;aid&quot;:&quot;3644740799867701&quot;,&quot;bid&quot;:600,&quot;dr&quot;:-1,&quot;independentaudio&quot;:true,&quot;m3u8&quot;:&quot;&quot;,&quot;pano&quot;:{&quot;type&quot;:1},&quot;qsvinfo_version&quot;:2,&quot;sdv&quot;:&quot;&quot;,&quot;st&quot;:&quot;&quot;,&quot;thdt&quot;:1,&quot;tht&quot;:0,&quot;title&quot;:&quot;&quot;,&quot;title_tail_info&quot;:{&quot;bt&quot;:99,&quot;bts&quot;:-1,&quot;et&quot;:2621,&quot;ete&quot;:-1,&quot;fe&quot;:1,&quot;le&quot;:0},&quot;tvid&quot;:&quot;3185901936393500&quot;,&quot;vd&quot;:{&quot;seg&quot;:{&quot;duration&quot;:[&quot;376140&quot;,&quot;365508&quot;,&quot;370300&quot;,&quot;371477&quot;,&quot;368311&quot;,&quot;368308&quot;,&quot;554319&quot;],&quot;rid&quot;:[&quot;a8c47c2906b88ae47e8503c96dae0494&quot;,&quot;4c8578cecbdfa3137a61b7e2bd1c68dc&quot;,&quot;4bc76f9b4d4ce995f40b42c467d206f8&quot;,&quot;8ed13ccd56aa2367f5eaabee12043d89&quot;,&quot;247b4612415c5b452f5965894a967e19&quot;,&quot;309400bef063cfd6baf19feb0d4a73a9&quot;,&quot;9771b1042cabfc9828767a3d0350f655&quot;],&quot;size&quot;:[&quot;75624801&quot;,&quot;84329329&quot;,&quot;90135782&quot;,&quot;82093900&quot;,&quot;91974933&quot;,&quot;75298884&quot;,&quot;111399115&quot;]},&quot;time&quot;:{&quot;et&quot;:&quot;2621000&quot;,&quot;st&quot;:&quot;99000&quot;}},&quot;vi&quot;:&quot;{\\&quot;writer\\&quot;:\\&quot;\\&quot;,\\&quot;authors\\&quot;:\\&quot;\\&quot;,\\&quot;upOrder\\&quot;:36,\\&quot;rewardAllowed\\&quot;:0,\\&quot;fl\\&quot;:[],\\&quot;allowEditVVIqiyi\\&quot;:0,\\&quot;isPopup\\&quot;:1,\\&quot;payMark\\&quot;:0,\\&quot;an\\&quot;:\\&quot;风吹半夏\\&quot;,\\&quot;pvu\\&quot;:\\&quot;\\&quot;,\\&quot;subType\\&quot;:1,\\&quot;rewardMessage\\&quot;:\\&quot;\\&quot;,\\&quot;ipLimit\\&quot;:1,\\&quot;pubTime\\&quot;:\\&quot;1673306651000\\&quot;,\\&quot;mainActorRoles\\&quot;:[],\\&quot;up\\&quot;:\\&quot;2023-01-17 20:20:02\\&quot;,\\&quot;un\\&quot;:\\&quot;\\&quot;,\\&quot;qiyiProduced\\&quot;:1,\\&quot;platforms\\&quot;:[],\\&quot;vn\\&quot;:\\&quot;风吹半夏第1集\\&quot;,\\&quot;plc\\&quot;:{\\&quot;4\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;40\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;10\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;5\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;41\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;22\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;32\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;11\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;12\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;7\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;13\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;14\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;91\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;34\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;9\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;6\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;16\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;17\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;27\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;28\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;18\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;29\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;1\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;50\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;31\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;15\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;2\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;3\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;21\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;30\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;19\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;8\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1},\\&quot;20\\&quot;:{\\&quot;downAld\\&quot;:1,\\&quot;coa\\&quot;:1}},\\&quot;sm\\&quot;:0,\\&quot;st\\&quot;:200,\\&quot;startTime\\&quot;:99,\\&quot;showChannelId\\&quot;:2,\\&quot;vu\\&quot;:\\&quot;http:\\\\/\\\\/www.iqiyi.com\\\\/v_uvxuws1kkw.html\\&quot;,\\&quot;povu\\&quot;:\\&quot;\\&quot;,\\&quot;ppsuploadid\\&quot;:0,\\&quot;qiyiPlayStrategy\\&quot;:\\&quot;非会员每日20:00转免1集\\&quot;,\\&quot;ar\\&quot;:\\&quot;内地\\&quot;,\\&quot;cc\\&quot;:0,\\&quot;videoQipuId\\&quot;:3185901936393500,\\&quot;albumQipuId\\&quot;:3644740799867701,\\&quot;pano\\&quot;:{\\&quot;type\\&quot;:1},\\&quot;subt\\&quot;:\\&quot;许半夏帮童骁骑驱霉运\\&quot;,\\&quot;endTime\\&quot;:2621,\\&quot;cpa\\&quot;:1,\\&quot;userVideocount\\&quot;:0,\\&quot;es\\&quot;:36,\\&quot;plg\\&quot;:2774,\\&quot;stl\\&quot;:{\\&quot;d\\&quot;:\\&quot;http:\\\\/\\\\/meta.video.iqiyi.com\\&quot;,\\&quot;stl\\&quot;:[]},\\&quot;subKey\\&quot;:\\&quot;3644740799867701\\&quot;,\\&quot;tvFocuse\\&quot;:\\&quot;赵丽颖欧豪携手创业\\&quot;,\\&quot;qtId\\&quot;:0,\\&quot;ty\\&quot;:0,\\&quot;ppsInfo\\&quot;:{\\&quot;shortTitle\\&quot;:\\&quot;风吹半夏第1集\\&quot;,\\&quot;name\\&quot;:\\&quot;风吹半夏第1集\\&quot;},\\&quot;sid\\&quot;:0,\\&quot;etm\\&quot;:\\&quot;\\&quot;,\\&quot;keyword\\&quot;:\\&quot;风吹半夏\\&quot;,\\&quot;pturl\\&quot;:\\&quot;\\&quot;,\\&quot;a\\&quot;:\\&quot;\\&quot;,\\&quot;isTopChart\\&quot;:0,\\&quot;idl\\&quot;:0,\\&quot;albumAlias\\&quot;:\\&quot;许半夏帮童骁骑驱霉运\\&quot;,\\&quot;stm\\&quot;:\\&quot;\\&quot;,\\&quot;pd\\&quot;:1,\\&quot;tags\\&quot;:[],\\&quot;coa\\&quot;:0,\\&quot;c\\&quot;:2,\\&quot;producers\\&quot;:\\&quot;\\&quot;,\\&quot;nurl\\&quot;:\\&quot;\\&quot;,\\&quot;tvEname\\&quot;:\\&quot;wild bloom\\&quot;,\\&quot;uid\\&quot;:\\&quot;0\\&quot;,\\&quot;asubt\\&quot;:\\&quot;\\&quot;,\\&quot;d\\&quot;:\\&quot;傅东育|毛溦\\&quot;,\\&quot;vid\\&quot;:\\&quot;a90ea47d4333331bb85f331c1130504c\\&quot;,\\&quot;dts\\&quot;:\\&quot;20230117202002\\&quot;,\\&quot;editorInfo\\&quot;:\\&quot;\\&quot;,\\&quot;tvSeason\\&quot;:0,\\&quot;ntvd\\&quot;:3185901936393500,\\&quot;vpic\\&quot;:\\&quot;http:\\\\/\\\\/pic6.iqiyipic.com\\\\/image\\\\/20221127\\\\/e2\\\\/52\\\\/v_170312139_m_601_m1.jpg\\&quot;,\\&quot;vType\\&quot;:0,\\&quot;cType\\&quot;:1,\\&quot;payMarkUrl\\&quot;:\\&quot;\\&quot;,\\&quot;apic\\&quot;:\\&quot;http:\\\\/\\\\/pic8.iqiyipic.com\\\\/image\\\\/20230104\\\\/6c\\\\/00\\\\/a_100498846_m_601_m26.jpg\\&quot;,\\&quot;shortTitle\\&quot;:\\&quot;风吹半夏第1集\\&quot;,\\&quot;tvid\\&quot;:3185901936393500,\\&quot;aid\\&quot;:3644740799867701,\\&quot;au\\&quot;:\\&quot;http:\\\\/\\\\/www.iqiyi.com\\\\/a_yq6d69gtw9.html\\&quot;,\\&quot;tvPhase\\&quot;:0,\\&quot;ifs\\&quot;:0,\\&quot;is\\&quot;:0,\\&quot;tpl\\&quot;:[],\\&quot;actors\\&quot;:[],\\&quot;isVip\\&quot;:\\&quot;\\&quot;,\\&quot;votes\\&quot;:[],\\&quot;previewImageUrl\\&quot;:\\&quot;http:\\\\/\\\\/preimage3.iqiyipic.com\\\\/preimage\\\\/20230110\\\\/6a\\\\/a6\\\\/v_170312139_m_611_m6.jpg\\&quot;,\\&quot;e\\&quot;:\\&quot;\\&quot;,\\&quot;cnPremTime\\&quot;:0,\\&quot;s\\&quot;:\\&quot;\\&quot;,\\&quot;ma\\&quot;:\\&quot;赵丽颖|欧豪|李光洁|刘威|柯蓝|任重|冯嘉怡|孙千|黄澄澄|是安|宋熹|王西|黄义威|王劲松|刘威葳|尤靖茹|林鹏（大陆男演员）|郝平|淮文|颜世魁|薛淑杰|刘硕|丁冠中|豆艺坤|寇钟吁|杨德民|傅宜箴|朱超艺|黄子琪|荣飞|田玲|周小镔|孔琳|方晓莉|陈创|韩朔|高远\\&quot;,\\&quot;supName\\&quot;:\\&quot;\\&quot;,\\&quot;sc\\&quot;:0,\\&quot;categoryKeywords\\&quot;:\\&quot;电视剧,3644740799867701,0,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/------------------.html 自制,12791537149997,2,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/-12791537149997-----------------.html 浙江卫视,20291787825994,0,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/------------------.html 家庭,23757144288056,2,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/-23757144288056-----------------.html 言情,23789230921965,2,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/-23789230921965-----------------.html 励志,29717236536467,2,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/-29717236536467-----------------.html 商战,32284167249109,2,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/-32284167249109-----------------.html 剧情,37979544767779,2,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/-37979544767779-----------------.html 都市,80141381722890,2,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/-80141381722890-----------------.html 内地,80526421329786,0,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/------------------.html 爱情,87328787718281,2,http:\\\\/\\\\/list.iqiyi.com\\\\/www\\\\/2\\\\/-87328787718281-----------------.html\\&quot;,\\&quot;onlineStatus\\&quot;:1,\\&quot;mdown\\&quot;:0,\\&quot;bmsg\\&quot;:{\\&quot;t\\&quot;:\\&quot;20230117202002\\&quot;,\\&quot;f\\&quot;:\\&quot;web\\&quot;,\\&quot;mid\\&quot;:\\&quot;\\&quot;,\\&quot;sp\\&quot;:\\&quot;26173601,\\&quot;},\\&quot;nvid\\&quot;:\\&quot;8ec7f862076f40ee17c908e2bbc3fae2\\&quot;,\\&quot;flpps\\&quot;:[],\\&quot;supType\\&quot;:\\&quot;\\&quot;,\\&quot;lg\\&quot;:2,\\&quot;is3D\\&quot;:0,\\&quot;bossStatus\\&quot;:0,\\&quot;isDisplayCircle\\&quot;:0,\\&quot;actorRoles\\&quot;:[],\\&quot;exclusive\\&quot;:1,\\&quot;circle\\&quot;:{\\&quot;type\\&quot;:0,\\&quot;id\\&quot;:0},\\&quot;commentAllowed\\&quot;:1,\\&quot;tg\\&quot;:\\&quot;忠犬 大女主 自制 工业强国 毒舌 重组家庭 渣男 浙江卫视 家庭 言情 霸道总裁 御姐 励志 个人成长 虐恋 双强 普通话 商战 硬汉 剧情 出轨 兄弟反目 女强人 爽剧 初恋 青年奋斗 热血 女性励志 群像 个人奋斗 接地气 女青年 大佬 原生家庭 猪队友 都市 内地 组团 爱情\\&quot;,\\&quot;info\\&quot;:\\&quot;1996年的秋天，阳光炫目。许半夏开着一辆桑塔纳，接着刚出狱的童骁骑驶往鹭州出差。一路上童骁骑默默无言，二人之间气氛尴尬。到了酒店后，许半夏的指示很清楚：洗澡，看电视，睡觉，第二天一早，她来接童骁骑一起出差。童骁骑点点头，在许半夏离开后，他开始洗澡，记忆也回到了五年前……\\\\n1991年的一个雨夜，童骁骑因为急着给妈妈筹医药费，撬了一堆下水井盖，蹬着三轮车拉到了许半夏和小陈的废品站。小陈认定童骁骑就是个骗子，不愿帮忙，但善良的半夏相信童骁骑，给了他钱，并且三个人一大早一起把井盖都送了回去。童骁骑为表感激，愿意替二人做事。许半夏提到当地钢厂有很多废了的下脚料，他们可以去收，但缺一辆大车。于是司机班出身的童骁骑真的把厂里的东风偷偷开了出来，三人摇摇晃晃进了钢厂，挣到了人生的第一桶金，但童骁骑也因为私自用车被厂里开除了。回到废品站的童骁骑心灰意冷，许半夏却安慰道正好，今后他们三个人就一块儿干，而这些钱就是他们的第一笔合伙资金。\\&quot;,\\&quot;supId\\&quot;:0,\\&quot;issueTime\\&quot;:0,\\&quot;dtype\\&quot;:3,\\&quot;producer\\&quot;:\\&quot;\\&quot;,\\&quot;presentor\\&quot;:[],\\&quot;followerCount\\&quot;:0}&quot;,&quot;vid&quot;:&quot;a90ea47d4333331bb85f331c1130504c&quot;,&quot;videotype&quot;:0}}s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="提取视频信息" tabindex="-1"><a class="header-anchor" href="#提取视频信息" aria-hidden="true">#</a> 提取视频信息</h2><p>获取视频信息，首先要先提取索引信息，根据索引信息中的偏移位置和字节大小获取，获取到的字节数组前1024个字节需要解密，根据头部信息中的<code>version</code>判断，如果是1则用老版本算法解密，如果是2则用新版本算法解密。</p><p>一个QSV文件包含多段视频数据，已发现的视频格式有flv（旧版客户端）、mpeg-ts（新版客户端）。可以通过前三个字节判断，如果前三个字节转字符串为<code>FLV</code>则为<code>FLV</code>格式。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">QSV</span> qsv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QSV</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\\\workspace\\\\c\\\\风吹半夏第1集-蓝光1080P.qsv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qsv<span class="token punctuation">.</span><span class="token function">readIndex</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\\\workspace\\\\c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qsv<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> outPath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//nb_indices</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nb_indices <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//索引</span>
    <span class="token comment">//_unknown_flag</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _unknown_flag <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x5A</span><span class="token punctuation">,</span> <span class="token function">toInt</span><span class="token punctuation">(</span>nb_indices<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span> <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;nb_indices:0x%s\\n_unknown_flag:%s&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>nb_indices<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">bytesToHex</span><span class="token punctuation">(</span>_unknown_flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//version:4byte</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> version <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0xA</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//索引体</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> indices <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token number">0x5A</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>nb_indices<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span> <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">toInt</span><span class="token punctuation">(</span>nb_indices<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x1C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">toInt</span><span class="token punctuation">(</span>nb_indices<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> indice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0x1C</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>indices<span class="token punctuation">,</span> <span class="token number">0x1C</span> <span class="token operator">*</span> i<span class="token punctuation">,</span> indice<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x1C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">decrypt_1</span><span class="token punctuation">(</span>indice<span class="token punctuation">,</span> indice<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">decrypt_2</span><span class="token punctuation">(</span>indice<span class="token punctuation">,</span> indice<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//索引体</span>
        <span class="token comment">//_codetable</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _codetable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>indice<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> _codetable<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//segment_offset</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> segment_offset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0x8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>indice<span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> segment_offset<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//segment_size</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> segment_size <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0x4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>indice<span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> segment_size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;_codetable:%s,segment_offset:0x%s,segment_size:0x%s&quot;</span><span class="token punctuation">,</span> <span class="token function">bytesToHex</span><span class="token punctuation">(</span>_codetable<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>segment_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>segment_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exportVideo</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> segment_offset<span class="token punctuation">,</span> segment_size<span class="token punctuation">,</span> outPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">exportVideo</span><span class="token punctuation">(</span><span class="token keyword">int</span> fileindex<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> segment_offset<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> segment_size<span class="token punctuation">,</span> <span class="token class-name">String</span> outPath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> file <span class="token operator">=</span> <span class="token function">getByteFromFile</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>segment_offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">toInt</span><span class="token punctuation">(</span>segment_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//前1024字节加密</span>
    <span class="token function">decrypt_2</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0x3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> head<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//System.out.println(new String(head));</span>
    <span class="token class-name">String</span> outname <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token class-name">File</span><span class="token punctuation">.</span>separator<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> outFile <span class="token operator">=</span> outPath <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> outname<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> outname<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-第&quot;</span> <span class="token operator">+</span> fileindex <span class="token operator">+</span> <span class="token string">&quot;段.&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RandomAccessFile</span> write <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;export:&quot;</span> <span class="token operator">+</span> outFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    write<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    write<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行结果：</p><div class="language-txt line-numbers-mode" data-ext="txt"><pre class="language-txt"><code>nb_indices:0x7
_unknown_flag:7F
_codetable:A8C47C2906B88AE47E8503C96DAE0494,segment_offset:0x1ee8,segment_size:0x481f161
export:D:\\workspace\\c\\风吹半夏第1集-蓝光1080P-第1段.flv
_codetable:4C8578CECBDFA3137A61B7E2BD1C68DC,segment_offset:0x4821049,segment_size:0x506c371
export:D:\\workspace\\c\\风吹半夏第1集-蓝光1080P-第2段.flv
_codetable:4BC76F9B4D4CE995F40B42C467D206F8,segment_offset:0x988d3ba,segment_size:0x55f5ce6
export:D:\\workspace\\c\\风吹半夏第1集-蓝光1080P-第3段.flv
_codetable:8ED13CCD56AA2367F5EAABEE12043D89,segment_offset:0xee830a0,segment_size:0x4e4a74c
export:D:\\workspace\\c\\风吹半夏第1集-蓝光1080P-第4段.flv
_codetable:247B4612415C5B452F5965894A967E19,segment_offset:0x13ccd7ec,segment_size:0x57b6d15
export:D:\\workspace\\c\\风吹半夏第1集-蓝光1080P-第5段.flv
_codetable:309400BEF063CFD6BAF19FEB0D4A73A9,segment_offset:0x19484501,segment_size:0x47cf844
export:D:\\workspace\\c\\风吹半夏第1集-蓝光1080P-第6段.flv
_codetable:9771B1042CABFC9828767A3D0350F655,segment_offset:0x1dc53d45,segment_size:0x6a3d0cb
export:D:\\workspace\\c\\风吹半夏第1集-蓝光1080P-第7段.flv
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2>`,42),m=n("code",null,"qsv2flv",-1),q={href:"https://github.com/btnkij/qsv2flv.git",target:"_blank",rel:"noopener noreferrer"},v=o("<p>该项目采用<code>c</code>语言和<code>Qt</code>开发，本文作者根据原理采用<code>Java</code>进行了翻写，仅供学习和参考。如果要用于实际应用，请使用原项目提供的工具，可以将<code>qsv</code>文件转换为<code>flv</code>或<code>mp4</code>格式。</p><p>工具较大且<code>github</code>下载速度较慢，可以关注公众号<code>OriginalTech</code>回复QSV获取。</p>",2),b={href:"https://mp.weixin.qq.com/s/2uKDdwMfUuJVNheaTTliXw",target:"_blank",rel:"noopener noreferrer"},y=n("h2",{id:"往期系列",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#往期系列","aria-hidden":"true"},"#"),s(" 往期系列")],-1),f={href:"https://mp.weixin.qq.com/s/eYJgqZlqKIR3r3wXbqATfA",target:"_blank",rel:"noopener noreferrer"};function w(g,h){const a=e("ExternalLinkIcon");return c(),u("div",null,[k,r,l(" more "),d,n("p",null,[s("本文参考开源项目"),m,s("，项目地址："),n("a",q,[s("https://github.com/btnkij/qsv2flv.git"),t(a)])]),v,n("p",null,[n("a",b,[s("​查看原文"),t(a)])]),y,n("p",null,[n("a",f,[s("​揭秘爱奇艺qsv文件背后的秘密"),t(a)])])])}const j=p(i,[["render",w],["__file","qsvextract.html.vue"]]);export{j as default};
